


<style>
    * {
    margin: 0;
    padding: 0;
    }
    tr {
        border: 0;
        padding: 0;
    }
    td,th {
        border: 1;
        padding: 0;
        margin: 0;
    }
    button {
        background-color: rgb(222, 217, 217);
    }
    .back {
        border-color:red;
    }
    /* canvas {
        border: 1px solid black;
    } */
</style>
    



<fieldset>
    <legend>南箫管门</legend>
    <button id="五空管-button" onclick="myFunction('五空管')">五空管</button>  
    <button id="四空管-button" onclick="myFunction('四空管')">四空管</button>  
    <button id="倍思管1-button" onclick="myFunction('倍思管1')">倍思管1</button>  
    <button id="倍思管2-button" onclick="myFunction('倍思管2')">倍思管2</button>  
     &nbsp; &nbsp;<button id="All-Key-button" onclick="myFunction('All')">All</button>  
    <br> <input type="checkbox" name="showHalf" id="showHalfChk" checked="True" onclick="myChkFunction()">是否显示半音（b/#）
    <br> 
</fieldset>

<div>
    <h2 id="Current-Key"></h2>
    <table id="Key-Table" border="2" bordercolor="black"></table>
    #: 升半音; b: 降半音; z: 还原符号（还原已升/降的音）
</div>


<div>
 <h2>常用管门</h2> 
 <img src="../Nanyin/0.png" alt="" width='90%'>    <br>    <br>
 <img src="../Nanyin/1.png" alt="" width='45%'>    
 <img src="../Nanyin/2.png" alt="" width='45%'>    <br>
 <img src="../Nanyin/3.png" alt="" width='45%'>   
 <img src="../Nanyin/4.png" alt="" width='45%'>    <br>
</div>

五空管中'δ'可略，当乐谱中不用'亻乂'、'彳乂'时为C宫，而当乐谱中不用'乂'时为G宫；<br>
四空管中'x'可略；<br>


<div>
 <h2>示例</h2> 

 <a href="https://www.bilibili.com/video/BV1Sj41137kd/">《八面金钱经》六节 折双清 -  四空管（节选）</a>  <br>
   <img src="../Nanyin/Octo_e2.png" alt="" width='90%'>    <br>
<table>
<tr> <td>谱中显示</td>  <td>乂</td> <td>工</td> <td>六</td> <td>思</td> <td>一</td>  <td>亻乂</td> <td>亻工</td> <td>亻六</td> <td>亻思</td> <td>亻一</td> </tr>
<tr> <td>实际指代</td>  <td>乂</td> <td>工</td> <td>x六</td> <td>思</td> <td>一</td>   <td>x亻乂</td> <td>亻工</td> <td>亻六</td> <td>亻思</td> <td>亻一</td> </tr>
<tr> <td>实际音</td>  <td>5.</td> <td>6.</td> <td>1</td> <td>2</td> <td>3</td>   <td>5</td> <td>6</td> <td>7</td> <td>^2</td> <td>^3</td></tr>
</table>  
* 四空管‘x六’简写为‘x六’; ‘x亻乂’同理; ‘下’超出了乐器范围因此不发音（？？）
  <br>




</div>


<div>
 <h2>南音工乂字谱</h2> 
 <img src="../Nanyin/zipuA.png" alt="" width='24%'>   
 <img src="../Nanyin/zipuB.png" alt="" width='24%'>   
 <img src="../Nanyin/zipuC.png" alt="" width='24%'>
 <img src="../Nanyin/zipuD.png" alt="" width='24%'>    <br>
</div>

<div>
 <h2>参考</h2> 
 黄书前 提供： <img src="../Nanyin/huang.jpg" alt="黄书前 处购箫所得指法谱">   <br>
 《泉州南音二弦教程》  <br>
 《泉州南音工乂谱与视唱》  <br>
 <strong>Q：黄书前指法谱与教材的南箫指法谱似乎对不上; 可能为不同按法</strong>
</div>

    
    
<script>
var fullTable = {
    '五空管': ["2.","3.","#4.","5.","6.","7.","1","#1",
                "2","3","4","#4","5","6","7","^1","#^1",
                "^2","^3","^5","^6","^7"],
    '四空管': ["6_","7_","#1.","2.","3.","#4.","5.","#5.",
                "6.","7.","1","#1","2","3","#4","5","#5",
                "6","7","^2","^3","^4"],
    '倍思管1': ["1.","2.","3.","4.","5.","6.","#6.","7.",
                "1","2","#2","3","4","5","6","#6","7",
                "^1","^2","^4","^5","^6"],
    '倍思管2': ["5_","6_","7.","1.","2.","3.","4.","#4.",
                "5","6","#6","7","1","2","3","4","#4",
                "5","6","^1","^2","^3"],
    "pressBack": [2,2,2,2,2,2,0,0,  0,2,2,2,2,2,2,2,2,  0,2,2,0,2],
    "press1":    [2,2,2,2,2,0,2,0,  2,2,2,2,2,2,0,0,0,  0,2,0,0,2],
    "press2":    [2,2,2,2,0,2,2,0,  2,2,2,2,2,0,2,2,2,  2,0,2,2,0],
    "press3":    [2,2,2,0,0,0,0,0,  2,2,2,2,0,0,2,2,2,  2,0,2,2,2],
    "press4":    [2,2,0,0,0,0,0,0,  2,2,0,0,0,0,2,2,0,  0,0,0,0,2],
    "press5":    [2,0,0,2,2,2,2,2,  2,0,2,0,2,2,2,0,0,  0,2,2,2,2],
}



function fillCircle(mycanvas,r,type,fillColor) {
    var ctx = mycanvas.getContext("2d");
    ctx.strokeStyle = fillColor;
    ctx.fillStyle = fillColor;
    ctx.beginPath();                
    ctx.arc(r, r, r, 0, Math.PI * 1, true); // (x,y,r,sAngle,eAngle,counterclockwise)
    if (type === "0") {ctx.stroke()} else {ctx.fill()};
    ctx.beginPath();                 
    ctx.arc(r, r, r, 0, Math.PI * 2, true); 
    if (type === "2") {ctx.fill()} else {ctx.stroke()};
}

function processStr(myTdStr){
    clean_str = myTdStr.replace(/#/g, "").replace(/@/g, "").replace(/_/g, "").replace(/\./g, "").replace(/\^/g, "");
    pound_str = ""
    myTdStr.split('').forEach(function (value,index){
        if (value === "#") {pound_str = `<sup>#</sup>`;};
        if (value === "_") {clean_str = `<span style="text-decoration: underline double">${clean_str}</span>`;};    // 双下划标识  _  -->   _ _ 
        if (value === ".") {clean_str = `<u>${clean_str}</u>`;}      //   下划标识  .  -->   _
        if (value === "^") {clean_str = `<span style="text-decoration: overline">${clean_str}</span>`;};  //   上划标识  -   -->  -
        if (value === "@") {clean_str = `<span style="text-decoration: overline double">${clean_str}</span>`;};  //   双上划标识@  -->  --
    })
    return `${pound_str}${clean_str}`                     
}

function tdElementStr(myTdStr) {
    tempTdStr = `<td style="padding-top:1px;padding-bottom:1px;padding-left:0;padding-rignt:0;text-align:right" width="30px">${processStr(myTdStr)}</td>`;
    return tempTdStr
}

function tdCanvasStr(myTdStr,canvasClass) {  // "Circle" "firstCircle"
    tempTdStr = `<td style="padding-top:1px;padding-bottom:1px;padding-left:0;padding-rignt:0;text-align:center" width="30px"><canvas class="${canvasClass}" width="16" height="16">${myTdStr}</canvas></td>`;
    return tempTdStr
}


function trElementStr (rowName,myArray,canvasClass) {
    tempTds = ``;
    tempTds += tdElementStr(rowName);
    if (canvasClass === "") {
        myArray.forEach(function (value,index) {tempTds += tdElementStr(value)});
    } else {
        myArray.forEach(function (value,index) {tempTds += tdCanvasStr(value,canvasClass)});
    };
    tempTrStr = `<tr>${tempTds}</tr>`;
    return tempTrStr;
}



function filterKeyIndex(fullTable,key,ifshowHalf){
    select_Idx = [];
    if (fullTable[key]=== undefined){
        select_Idx = Array.from({length: fullTable['pressBack'].length}, (val, i) => i);
    }else{
        fullTable[key].forEach((value,index) => {
if (value !== "" && (ifshowHalf || (value.indexOf("#") === -1 && value.indexOf("b") === -1) )) {
                select_Idx.push(index)
            };
        });

    }

    return select_Idx;

}


function getValueByIndex(select_Idx,fullTable,word){
    select_Val = [];
    select_Idx.forEach(
        (Idx,_Index) => {
            select_Val.push(fullTable[word][Idx]);
        }
    );
    return select_Val;
}


function mainFunc(fullTable,key,ifshowHalf){
    document.getElementById('Current-Key').textContent = key;
    var select_Idx = filterKeyIndex(fullTable,key,ifshowHalf);
    if (key === "All"){
        var text_Keynote = ``;
        var keys = ['五空管','四空管','倍思管1','倍思管2']
        keys.forEach(
            (kk,index) => {text_Keynote += trElementStr(kk.split('-')[0],getValueByIndex(select_Idx,fullTable,kk),"");}
        )
    }else{
        var text_Keynote =   trElementStr("简",getValueByIndex(select_Idx,fullTable,key),"");
    }
    var text_pressBack = trElementStr("后",getValueByIndex(select_Idx,fullTable,'pressBack'),"firstCircle");
    var text_press1 = trElementStr("一",getValueByIndex(select_Idx,fullTable,'press1'),"Circle");
    var text_press2 = trElementStr("二",getValueByIndex(select_Idx,fullTable,'press2'),"Circle");
    var text_press3 = trElementStr("三",getValueByIndex(select_Idx,fullTable,'press3'),"Circle");
    var text_press4 = trElementStr("四",getValueByIndex(select_Idx,fullTable,'press4'),"Circle");
    var text_press5 = trElementStr("五",getValueByIndex(select_Idx,fullTable,'press5'),"Circle");

    document.getElementById("Key-Table").innerHTML = `${text_Keynote}${text_pressBack}${text_press1}${text_press2}${text_press3}${text_press4}${text_press5}`;
    
    canvasObjs = document.querySelectorAll('canvas.Circle');    // canvasObjs = document.getElementsByTagName('canvas')
    for (k=0;k<canvasObjs.length;k++) {
        fillCircle(canvasObjs[k],8,canvasObjs[k].textContent,'black');
    }
    canvasObjs = document.querySelectorAll('canvas.firstCircle');  
    for (k=0;k<canvasObjs.length;k++) {
        fillCircle(canvasObjs[k],8,canvasObjs[k].textContent,'orange');
    }
}

currentKey = "All";
ifshowHalf = document.querySelector('#showHalfChk').checked;
mainFunc(fullTable,currentKey,ifshowHalf)

function myFunction(newKey) {
    currentKey = newKey;
    mainFunc(fullTable,currentKey,ifshowHalf);
}

function myChkFunction() {
    ifshowHalf = document.querySelector('#showHalfChk').checked;
    mainFunc(fullTable,currentKey,ifshowHalf);
    // if (ifshowHalf){mainFunc(fullTable,currentKey);}else{mainFunc(fullTable,currentKey)}
}

</script>
    
    
    
    